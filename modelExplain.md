# 模型解释 of 投点计算器

——by Joat917, undergraduate in Peking Univ.

> 这个文档只会解释投点计算器中最为关键的一个公式，而不会解释如何根据这两个公式实现计算的功能。
> 如果你想要了解技术细节，我写了一个可读性极强的python代码文件`toudianExplanation.py`，希望大家能够参考这个进行理解。

投点计算器本质上就是：
1. 根据已选限选比例猜出除了你以外的其他学生投点的分布；
2. 根据已知的所有学生的投点数算出你的选上概率；
3. 根据2中的概率-投点函数，最优化投点分布，使得选上的概率的加权平均最大。

其中第1步，据我所知，没什么好的办法。在这里我提供了几个模型供大家选择，一些认为别人投点不会随着选课比例变化，另一些沿用了学长在他们的计算器中使用的算法（很遗憾，这个我不会解释）。

接下来的篇幅中，我会详细推导第2步的公式，并给出它的一种近似表达式。

## 原始公式的推导

这个模型的原型是：
1. 有n个人抢m个名额($m<n$)，每个人都投了$x_i(1\leqslant i\leqslant n)$点。
2. 每个人抢到名额的概率和他投的点数成正比。
3. 求第一个人抢到名额的概率。

简单起见，我们可以假设小明在这门课上面投了$x$点，其余$(n-1)$个人均在这门课上投了$y$点。

> 事实上，其他人均匀投点的这个假设是**最坏**的情况。
> 在其他人投点总和不变的情况下，投点不均匀会**增加**小明选上的概率。
> 也就是说，如果考虑现实因素，投点计算器给出的概率事实上是偏小的，你的未来更加乐观。
> 你可以思考一下这是为什么。

那么，当海淀大赌场的轮盘开始转动时，会发生什么事呢？

枪响了，所有人开始争抢第一个名额。对于小明而言，如果他抢到了名额，那么一切都结束了；但是如果他没抢到，他还需要在剩下的(m-1)个名额中加油。他没抢到的概率为：

$$
P(\text{第一次没抢到})=\frac{(n-1)y}{x+(n-1)y}
$$

枪又响了，大家开始争抢第二个名额。不灰心的小明果然又没抢到，不出所料，他需要进入第三轮。这件事发生的概率为：

$$
P(\text{第二次没抢到}|\text{第一次没抢到})=\frac{(n-2)y}{x+(n-2)y}
$$

轮盘飞速运转。眨眼间，倒数第二个名额开奖，小明仍不在此列。他已经失败了$(m-1)$次，能不能抓住这最后一个名额，逆风翻盘呢？希望渺茫，因为选不上的概率已经增加到了：

$$
P(\text{第m次没抢到}|\text{第(m-1)次没抢到})=\frac{(n-m)y}{x+(n-m)y}
$$

这个故事告诉我们，小明的运气真差。

他需要连续失败m次才能落到抢不上名额的地步，哪怕他成功了一次都不至于一次也不成功啊。

根据条件概率的Bayes公式，他抢不上名额的概率由一个乘积给出：

$$
P(\text{第m次也没抢到})=\prod_{i=1}^m \frac{(n-i)y}{x+(n-i)y}
$$

简化起见，定义一个变量 $\eta=x/y$，这个公式也写为

$$
P(\text{没抢到})=\prod_{i=1}^m \frac{n-i}{n-i+\eta}
$$

## 如何化简

直接算它也不是不行，但是我在学长写的投点公式里面发现了一个神奇的公式，它是这样说的：

$$
P(\text{没抢到})=\Big(\frac{n-m+\eta}{n+\eta}\Big)^{0.55\eta+0.5}\cdot \Big(\frac{n}{n-m}\Big)^{0.5-0.45\eta}
$$

这个公式的存在有几个疑问：
1. 为啥会出现根号（指数上的0.5次方）？
2. 为啥指数上有$\eta$，而且它的系数是0.55和0.45这些和数学常数无关的magical number？
3. 原始公式中的求积怎么就消失了？
4. 为什么近似公式的结果**仅小于原始公式不到百分之一**？这是如何做到的？
5. 为什么当已选和限选人数非常接近的时候这个公式爆炸了？又为什么当已选人数不显著大于10的时候公式仍然爆炸了？

<!-- 我不是数值计算有关专业的，但是我可以在这里根据自己的理解尝试给出这些问题解答。

**俗话说的好，只要参数数量足够多，神仙来了都能把祂拟合拟出来。**

所以我只需要构造一个满足某些边界条件的式子，然后在里面堆入令人发指的参数，我就一定能做到对原始公式的合理近似。

以下是掉课率P满足的条件：

1. 在给定n和m时，当$\eta$趋于0的时候，(1-P)线性地趋于0。
2. 在给定n和m时，当$\eta$趋于无穷的时候，P趋于0。*（但从现实意义考虑，$\eta$最高也就三四，仍然可以看做是远小于动辄几十几百的m和n）*
3. 在m和$\eta$远小于n的时候，P趋于1。
4. 当m趋近于n而$\eta$远小于n的时候，P趋近于0。
5. 在任何时候P大于0小于1。

据此我们可以假设出近似公式具有如下的形式：

$$
P_1=\Big(\frac{a_1n+a_2m+a_3\eta+a_4}{a_5n+a_6m+a_7\eta+a_8}\Big)^{a_9n+a_{10}m+a_{11}\eta+a_{12}}
$$

接下来我们根据条件来消参数。

根据条件1，当$\eta$趋于0的时候，P要线性地趋于1，所以指数上的部分要趋于0，这件事不依赖于m和n的取值，所以$a_9=a_{10}=a_{12}=0,a_{11}>0$。

根据条件3，$a_1=a_5$且$a_4=a_8$。
根据条件4，$a_1=-a_2$且$a_3=a_4=0$
根据条件2和5，$a_6\geqslant a_2$且$a_7\geqslant a_3$

现在我们只需要拟合

$$
P_1=\Big(\frac{a_1n-a_1m}{a_1n+a_6m+a_7\eta}\Big)^{a_{11}\eta}
$$

或者可以消去冗余参数$a_1$得到

$$
P_1=\Big(\frac{n-m}{n+a_6m+a_7\eta}\Big)^{a_{11}\eta}
$$

拟合三个参数得到

...

这显然还是差点火候。我们可以堆上更多参数，假设：

$$
P_2=\Big(\frac{a_1n+a_2m+a_3\eta+a_4}{a_5n+a_6m+a_7\eta+a_8}\Big)^{a_9n+a_{10}m+a_{11}\eta+a_{12}}\cdot\Big(\frac{b_1n+b_2m+b_3\eta+b_4}{b_5n+b_6m+b_7\eta+b_8}\Big)^{b_9n+b_{10}m+b_{11}\eta+b_{12}}
$$

不妨假设指数上都需要是正的，那么两个底数都需要在0到1中间。

考虑条件3，那么$a_1=a_5$且$a_4=a_8$且$b_1=b_5$且$b_4=b_8$。

考虑条件4，那么$a_1+a_2=0$或$b_1+b_2=0$。这里就假设$b_1+b_2=0$，那么$b_3=b_4=0$。

根据条件1，当$\eta$趋于0的时候，整个东西都要趋于1，不依赖于m和n的取值。那么$a_9=a_{10}=b_9=b_{10}=0,a_{12}+b_{12}=0$。

还是条件1，如果这个时候m和n非常接近，$P_2$不应当取到0或者无穷，意味着$n-m$在这时能够被抵消掉，所以$a_1+a_2=0,a_4=0$。

现在已经可以把$P_2$化简为

$$
P_2=\Big(\frac{n-m+a_3\eta}{n+a_6m+a_7\eta}\Big)^{a_{11}\eta+a_{12}}\cdot\Big(\frac{n-m}{n+b_6m+b_7\eta}\Big)^{b_{11}\eta-a_{12}}
$$

拟合8个参数得到

...
 -->

如果你知道$\Gamma$函数并听说过Stirling公式，那么第1和第3个问题就立马不是问题了。

原无穷求积可以写为$\Gamma$函数的形式：

$$
P(\text{没抢到})=\frac{\Gamma(n)}{\Gamma(n-m)}\cdot\frac{\Gamma(n-m+\eta)}{\Gamma(n+\eta)}
$$

而又众所周知，

$$
\Gamma(x+1)\approx\sqrt{2\pi x}\left(\frac{x}{\mathrm{e}}\right)^x
$$

直接代入得到：

$$
P(\text{没抢到})=\sqrt{\frac{(n-1)(n-m+\eta-1)}{(n-m-1)(n+\eta-1)}}\cdot\frac{(n-1)^{n-1}(n-m+\eta-1)^{n-m+\eta-1}}{(n-m-1)^{n-m-1}(n+\eta-1)^{n+\eta-1}}
$$

右侧那个指数结构，在考虑到$\eta$远小于$m,n,m-n$的极限下，根据下列公式（这个公式稍后证明）

$$
\frac{(a+x)^{a+x}}{a^a}\approx e^x a^{\frac x2}(a+x)^{\frac x2},\ \text{given}\ x\approx 0
$$

可以化简为

$$
P(\text{没抢到})=\sqrt{\frac{(n-1)(n-m+\eta-1)}{(n-m-1)(n+\eta-1)}}\cdot\frac{(n-m-1)^{\frac\eta2}}{(n-1)^{\frac\eta2}}\cdot \frac{(n-1+\eta)^{\frac\eta2}}{(n-m-1+\eta)^{\frac\eta2}}
$$

或者换种写法：

$$
P(\text{没抢到})=\left(\frac{n-1}{n-m-1}\right)^{0.5-0.5\eta} \left(\frac{n-m+\eta-1}{n+\eta-1}\right)^{0.5+0.5\eta}
$$

这就长得非常像我在学长给出的Javascript中给出的公式，但是还是存在细微的差别；具体就是第二个疑问，如何解释神奇常数0.45和0.55。

我给出一个猜测，可能是学长在推导公式的时候不慎漏了一个1，然后拼命调参试图抵消这个1带来的影响；最终的结果是把指数上的0.5调到了略微偏离(0.45,0.55)，发现这样不错，于是就凑活着用了。

不过话说回来，这么近似有个小前提，就是要保证Stirling公式能够成立；也就是说，$n$能太小，而且$n-m$也不能太小。这解释了以上提出的第4和第5个疑问。至此，所有疑问全部解决。

不对，还差一个……

## 证它

$$
\frac{(a+x)^{a+x}}{a^a}\stackrel{?}{=} e^x a^{\frac x2}(a+x)^{\frac x2},\ \text{given}\ x\approx 0
$$

等式两侧同时取对数

$$
(a+x)\ln(a+x)-a\ln a\stackrel{?}{=} x+\frac x2 \ln a+\frac x2 \ln(a+x)
$$

Taylor展开到二阶

$$
\begin{align*}
    [a\ln a+x (\ln a+1)+\frac12 x^2(\frac1a)+O(x^3)]-a\ln a\\\stackrel{?}{=} x+\frac x2 \ln a+\frac x2 [\ln a+x(\frac1a)+O(x^2)]
\end{align*}
$$

整理后发现等式两侧是相等的，这就证明完了。注意到这个公式在二阶近似下仍然成立，它和原公式的差别相当小。
